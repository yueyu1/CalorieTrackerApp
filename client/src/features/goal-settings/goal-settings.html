<div class="page">
  @if (!this.isLoading()) {
  <!-- Header -->
  <header class="page-header">
    <div class="page-header-left">
      <div class="title">Goals & Settings</div>
      <div class="subtitle">Tune your daily targets and display preferences.</div>
    </div>
  </header>

  <!-- HERO / Overview -->
  <section class="hero">
    <div class="hero-main">
      <div class="hero-kicker">Daily target</div>

      <div class="hero-value">
        <span class="hero-number">{{ caloriesControl?.value | number }}</span>
        <span class="hero-unit">kcal</span>
      </div>

      <div class="hero-meta">
        @if (macroModeControl?.value === 'percent') {
        <span class="pill">Protein: {{ proteinControl?.value }}%</span>
        <span class="pill">Carbs: {{ carbsControl?.value }}%</span>
        <span class="pill">Fat: {{ fatControl?.value }}%</span>
        <span class="sum-pill" [class.sum-pill--warn]="percentInvalid">
          Total: {{ percentSum }}%
        </span>
        } @else {
        <span class="pill">Protein: {{ proteinControl?.value }} g</span>
        <span class="pill">Carbs: {{ carbsControl?.value }} g</span>
        <span class="pill">Fat: {{ fatControl?.value }} g</span>
        @if (macroCaloriesPreview !== null) {
        <span class="sum-pill">
          ~{{ macroCaloriesPreview }} kcal from macros
        </span>
        }
        }
      </div>
    </div>

    <div class="hero-side">
      <div class="status-chip" [class.status-chip--pending]="showPendingChip"
        [class.status-chip--warn]="showInvalidChip" [class.status-chip--neutral]="showNotSetChip">
        <mat-icon [fontIcon]="chipIcon" class="status-icon"></mat-icon>
        {{ chipText }}
      </div>

      <div class="hero-note">
        @if (showNotSetChip) {
        Set your goals and hit Save to apply them to the Daily Log.
        }
        @else if (showPendingChip) {
        Save changes to apply them to today’s Daily Log.
        }
        @else if (showInvalidChip) {
        Fix macro total to 100% to apply changes.
        }
        @else {
        Your goals drive Daily Log progress bars and macro percentages.
        }
      </div>

    </div>
  </section>

  <!-- Main layout -->
  <div class="layout">
    <!-- Left column: Goals -->
    <section class="stack">
      <!-- Goals card -->
      <mat-card class="card card--panel">
        <div class="card-head">
          <div>
            <div class="card-title">Calories & Macros</div>
            <div class="card-sub">Set a calorie target and macro distribution.</div>
          </div>
        </div>

        <form [formGroup]="form" class="form">
          <div class="goal-grid">
            <!-- Calories -->
            <div class="calories-block">
              <div class="block-label">Daily calories</div>

              <mat-form-field appearance="outline" class="calories-field">
                <mat-label>Calories</mat-label>
                <input matInput type="number" formControlName="calories" (blur)="onCaloriesBlur()" />
                <span matTextSuffix>kcal</span>
                @if (this.caloriesControl?.hasError('min')) {
                <mat-error>Too low</mat-error>
                }
                @if (this.caloriesControl?.hasError('max')) {
                <mat-error>Too high</mat-error>
                }
                @if (this.caloriesControl?.hasError('calories required')) {
                <mat-error>Required</mat-error>
                }
              </mat-form-field>

              <div class="micro-hint">
                Common range: 1,600-3,000 kcal (you can go outside if needed).
              </div>
            </div>

            <!-- Macro mode + hint -->
            <div class="mode-block">
              <div class="block-label">Macro mode</div>

              <mat-button-toggle-group formControlName="macroMode" aria-label="Macro mode" class="toggle">
                <mat-button-toggle value="percent">Percent</mat-button-toggle>
                <mat-button-toggle value="grams">Grams</mat-button-toggle>
              </mat-button-toggle-group>

              @if (macroModeControl?.value === 'percent') {
              <div class="micro-hint">
                Total must equal 100%.
                @if (percentInvalid) {
                <span class="warn">
                  Currently {{ percentSum }}%.
                </span>
                }
              </div>
              }

              @if (macroModeControl?.value === 'grams') {
              <div class="micro-hint">
                Tip: grams use the 4/4/9 calorie rule for preview.
              </div>
              }
            </div>
          </div>

          <!-- Macro inputs -->
          <div class="macro-panel">
            <div class="macro-panel-head">
              <div class="macro-panel-title">Macro distribution</div>
              <div class="macro-panel-sub">
                {{ macroModeControl?.value === 'percent' ? 'Percent of macro calories' : 'Daily grams' }}
              </div>
            </div>

            <div class="macro-grid">
              <mat-form-field appearance="outline" class="macro-field macro-field--p">
                <mat-label>Protein</mat-label>
                <input matInput type="number" formControlName="protein" />
                <span matTextSuffix>{{ macroModeControl?.value === 'percent' ? '%' : 'g' }}</span>
              </mat-form-field>

              <mat-form-field appearance="outline" class="macro-field macro-field--c">
                <mat-label>Carbs</mat-label>
                <input matInput type="number" formControlName="carbs" />
                <span matTextSuffix>{{ macroModeControl?.value === 'percent' ? '%' : 'g' }}</span>
              </mat-form-field>

              <mat-form-field appearance="outline" class="macro-field macro-field--f">
                <mat-label>Fat</mat-label>
                <input matInput type="number" formControlName="fat" />
                <span matTextSuffix>{{ macroModeControl?.value === 'percent' ? '%' : 'g' }}</span>
              </mat-form-field>
            </div>

            <div class="macro-footer">
              @if (macroModeControl?.value === 'percent') {
              <div class="macro-footer-left">
                <span class="badge" [class.badge--warn]="percentInvalid">
                  Total: {{ percentSum }}%
                </span>
                @if (!percentInvalid) {
                <span class="muted">Looks good.</span>
                }
              </div>
              }

              @if (macroModeControl?.value === 'grams') {
              <div class="macro-footer-left">
                @if (macroCaloriesPreview !== null) {
                <span class="badge">
                  ~{{ macroCaloriesPreview }} kcal from macros
                </span>
                }
                <span class="muted">Calories implied by your macro gram targets doesn't need to match your daily calorie target.</span>
              </div>
              }

              <div class="macro-footer-right">
                <button mat-stroked-button type="button" class="ghost" (click)="applyPreset('maintain')">
                  Reset to Maintain
                </button>
              </div>
            </div>
          </div>
        </form>
      </mat-card>
    </section>

    <!-- Right column: Preferences -->
    <aside class="stack">
      <mat-card class="card card--panel card--prefs">
        <div class="card-head">
          <div>
            <div class="card-title">Preferences</div>
            <div class="card-sub">Display choices for labels and stats.</div>
          </div>
        </div>

        <form [formGroup]="form" class="prefs">
          <div class="pref-row">
            <div class="pref-left">
              <div class="pref-title">Weight units</div>
              <div class="pref-sub">Used in food unit labels and conversions.</div>
            </div>

            <mat-button-toggle-group formControlName="weightUnit" aria-label="Weight units"
              class="toggle toggle--compact">
              <mat-button-toggle value="g">g</mat-button-toggle>
              <mat-button-toggle value="oz">oz</mat-button-toggle>
            </mat-button-toggle-group>
          </div>

          <mat-divider class="divider"></mat-divider>

          <div class="pref-row pref-row--switch">
            <div class="pref-left">
              <div class="pref-title">Show macro percentages</div>
              <div class="pref-sub">If off, meal summaries show grams only.</div>
            </div>

            <mat-slide-toggle formControlName="showMacroPercent"></mat-slide-toggle>
          </div>
        </form>
      </mat-card>

      <mat-card class="card card--panel">
        <div class="helper">
          <div class="helper-icon">
            <mat-icon fontIcon="tips_and_updates"></mat-icon>
          </div>
          <div class="helper-text">
            <div class="helper-title">Tip</div>
            <div class="helper-sub">
              <ul class="tip-list">
                @if (macroModeControl?.value === 'percent') {
                <li>
                  Keep macros at <strong>100%</strong> for accurate progress.
                </li>
                }
                @if (macroModeControl?.value === 'grams') {
                <li>
                  Macro preview uses the <strong>4/4/9</strong> rule.
                </li>
                }
                <li>
                  You can update goals anytime — Daily Log adjusts automatically.
                </li>
                <li>
                  Goals apply per day — historical logs are not changed.
                </li>
              </ul>
            </div>
          </div>
        </div>
      </mat-card>
    </aside>

    <!-- Presets -->
    <mat-card class="card card--panel presets-full">
      <div class="card-head">
        <div>
          <div class="card-title">Presets</div>
          <div class="card-sub">Quick starting points — adjust anytime.</div>
        </div>
      </div>

      <div class="preset-grid">
        <button type="button" class="preset-card" [class.is-active]="activePreset() === 'maintain'"
          (click)="applyPreset('maintain')">
          <div class="preset-top">
            <div class="preset-icon preset-icon--maintain">
              <mat-icon fontIcon="balance"></mat-icon>
            </div>
            <div class="preset-text">
              <div class="preset-title">Maintain</div>
              <div class="preset-sub">Balanced macros · steady calories</div>
            </div>
          </div>
          <div class="preset-foot">
            <span class="preset-chip">30/40/30</span>
            <span class="preset-chip">keep calories</span>
          </div>
        </button>

        <button type="button" class="preset-card" [class.is-active]="activePreset() === 'cut'"
          (click)="applyPreset('cut')">
          <div class="preset-top">
            <div class="preset-icon preset-icon--cut">
              <mat-icon fontIcon="south"></mat-icon>
            </div>
            <div class="preset-text">
              <div class="preset-title">Cut</div>
              <div class="preset-sub">Lower calories · higher protein</div>
            </div>
          </div>
          <div class="preset-foot">
            <span class="preset-chip">35/35/30</span>
            <span class="preset-chip">-15% kcal</span>
          </div>
        </button>

        <button type="button" class="preset-card" [class.is-active]="activePreset() === 'bulk'"
          (click)="applyPreset('bulk')">
          <div class="preset-top">
            <div class="preset-icon preset-icon--bulk">
              <mat-icon fontIcon="north"></mat-icon>
            </div>
            <div class="preset-text">
              <div class="preset-title">Bulk</div>
              <div class="preset-sub">More calories · carb-forward</div>
            </div>
          </div>
          <div class="preset-foot">
            <span class="preset-chip">30/45/25</span>
            <span class="preset-chip">+10% kcal</span>
          </div>
        </button>
      </div>
    </mat-card>
  </div>

  <!-- Sticky save bar -->
  <div class="save-bar" [class.save-bar--visible]="isDirty">
    <div class="save-left">
      <mat-icon fontIcon="info" class="info-icon"></mat-icon>
      <div>
        <div class="save-title">Unsaved changes</div>
        <div class="save-sub">Review and save when you’re ready.</div>
      </div>
    </div>

    <div class="save-actions">
      <button mat-button type="button" (click)="cancel()">Cancel</button>
      <button mat-raised-button color="primary" type="button" (click)="save()"
        [disabled]="form.invalid || !isDirty || (macroModeControl?.value === 'percent' && percentInvalid)">
        Save changes
      </button>
    </div>
  </div>
  }

  @else {
  <header class="page-header">
    <div class="page-header-left">
      <div class="sk-line sk-title"></div>
      <div class="sk-line sk-sub"></div>
    </div>
  </header>

  <section class="hero sk-hero">
    <div class="sk-hero-main">
      <div class="sk-line sk-kicker"></div>
      <div class="sk-line sk-hero-number"></div>
      <div class="sk-pill-row">
        <span class="sk-pill"></span>
        <span class="sk-pill"></span>
        <span class="sk-pill"></span>
        <span class="sk-pill sk-pill--strong"></span>
      </div>
    </div>
    <div class="sk-hero-side">
      <div class="sk-line sk-chip"></div>
      <div class="sk-line sk-note"></div>
      <div class="sk-line sk-note sk-note--short"></div>
    </div>
  </section>

  <div class="layout">
    <section class="stack">
      <mat-card class="card card--panel sk-card">
        <div class="sk-line sk-card-title"></div>
        <div class="sk-line sk-card-sub"></div>

        <div class="sk-grid">
          <div class="sk-field"></div>
          <div class="sk-field"></div>
        </div>

        <div class="sk-panel"></div>
      </mat-card>
    </section>

    <aside class="stack">
      <mat-card class="card card--panel sk-card">
        <div class="sk-line sk-card-title"></div>
        <div class="sk-line sk-card-sub"></div>

        <div class="sk-row"></div>
        <div class="sk-row"></div>
      </mat-card>

      <mat-card class="card card--panel sk-card">
        <div class="sk-line sk-card-title"></div>
        <div class="sk-line sk-card-sub"></div>
        <div class="sk-paragraph">
          <div class="sk-line"></div>
          <div class="sk-line"></div>
          <div class="sk-line sk-line--short"></div>
        </div>
      </mat-card>
    </aside>

    <mat-card class="card card--panel sk-card presets-full">
      <div class="sk-line sk-card-title"></div>
      <div class="sk-line sk-card-sub"></div>

      <div class="preset-grid">
        <div class="sk-preset"></div>
        <div class="sk-preset"></div>
        <div class="sk-preset"></div>
      </div>
    </mat-card>
  </div>
  }

</div>