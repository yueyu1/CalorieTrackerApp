<div class="page">
  <header class="page-header">
    <h1 class="page-title">My Foods</h1>
    <p class="page-subtitle">
      Manage your custom foods for fast, consistent logging.
    </p>
  </header>

  <!-- HERO -->
  <section class="hero">
    <div class="hero-left">
      <div class="kicker">
        <span class="kicker-icon" aria-hidden="true">
          <mat-icon fontIcon="inventory_2"></mat-icon>
        </span>
        <span class="kicker-text">Food Library</span>

        <span class="kicker-dot"></span>

        <span class="kicker-meta">
          {{ visibleFoods().length }} visible
          @if(showArchived()) {
          <span>· archived included</span>
          }
        </span>
      </div>

      <p class="hero-headline">
        Your personal food library for fast, consistent logging
      </p>

      <p class="hero-subtitle">
        Create, edit, and organize foods for quick logging — always clean, always ready.
      </p>

      <div class="hero-chips" aria-label="Highlights">
        <span class="hchip">
          <mat-icon fontIcon="bolt"></mat-icon>
          Fast add
        </span>
        <span class="hchip">
          <mat-icon fontIcon="edit_note"></mat-icon>
          Custom units
        </span>
        <span class="hchip">
          <mat-icon fontIcon="verified"></mat-icon>
          Brand aware
        </span>
      </div>
    </div>

    <div class="hero-right">
      <div class="hero-actions">
        <button mat-raised-button class="btn-primary" type="button" (click)="onCreateFood()">
          <mat-icon fontIcon="add"></mat-icon>
          Create Food
        </button>
      </div>

      <div class="hero-mini">
        <div class="mini-row">
          <mat-icon fontIcon="search"></mat-icon>
          <span>Search & sort your catalog</span>
        </div>
        <div class="mini-row">
          <mat-icon fontIcon="inventory_2"></mat-icon>
          <span>Archive instead of deleting</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Toolbar -->
  <div class="toolbar">
    <form [formGroup]="form">
      <mat-form-field appearance="outline" class="search">
        <mat-icon matPrefix fontIcon="search"></mat-icon>
        <input matInput placeholder="Search my foods..." formControlName="search" />
        @if (searchCtrl.value) {
        <button mat-icon-button matSuffix type="button" aria-label="Clear" (click)="searchCtrl.setValue('')">
          <mat-icon fontIcon="close"></mat-icon>
        </button>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="field">
        <mat-icon matPrefix fontIcon="sort"></mat-icon>
        <mat-select panelClass="panel-soft" formControlName="sort">
          <mat-option value="recent">Sort: Recent</mat-option>
          <mat-option value="name">Sort: Name</mat-option>
          <mat-option value="calories">Sort: Calories</mat-option>
          <mat-option value="protein">Sort: Protein</mat-option>
          <mat-option value="carbs">Sort: Carbs</mat-option>
          <mat-option value="fat">Sort: Fat</mat-option>
        </mat-select>
      </mat-form-field>
    </form>

    <div class="spacer"></div>

    <button mat-icon-button class="tool-btn" type="button" (click)="toggleArchived()" [disabled]="archivedCount() <= 0"
      [matTooltip]="showArchived() ? 'Hide archived' : 'Show archived'">
      <mat-icon fontIcon="inventory_2"></mat-icon>
    </button>
  </div>

  <!-- Meta -->
  <div class="meta">
    <span>{{ visibleFoods().length }} foods</span>
    @if (showArchived()) {
    <span class="hint">Showing archived items</span>
    }
  </div>

  <!-- Card -->
  <div class="card">
    <!-- Header row -->
    <div class="grid header">
      <div class="col-select">
        <mat-checkbox [checked]="allVisibleSelected" [indeterminate]="someVisibleSelected" [disabled]="visibleFoods().length === 0"
          (change)="toggleAllVisible($event.checked)" aria-label="Select all visible">
        </mat-checkbox>
      </div>

      <div class="col-food">Food</div>
      <div class="col-kcal">Calories</div>
      <div class="col-macros">Macros</div>
      <div class="col-actions">Actions</div>
    </div>

    <!-- Rows -->
    @if (!loading()) {
    @for (f of visibleFoods(); track f.id) {
    <div class="grid row">
      <div class="col-select">
        <mat-checkbox [checked]="isSelected(f.id)" (change)="toggleRow(f.id)" aria-label="Select row"></mat-checkbox>
      </div>

      <div class="col-food">
        <div class="food-cell">
          <div class="food-name">
            {{ f.name }}
            @if (f.isArchived) {
            <span class="archived">Archived</span>
            }
          </div>

          <div class="food-sub">
            @if (f.brand) {
            <span class="brand">{{ f.brand }}</span>
            <span class="dot"></span>
            }
            <span>{{ primaryUnitLabel(f) }}</span>
            <span class="dot"></span>
            <span class="base">{{ baseLine(f) }}</span>
          </div>
        </div>
      </div>

      <div class="col-kcal">
        <div class="kcal">
          <span class="kcal-value">{{ f.calories }}</span>
        </div>
      </div>

      <div class="col-macros">
        <div class="macro-chips">
          <mat-chip class="chip chip-p">P·{{ f.protein }}g</mat-chip>
          <mat-chip class="chip chip-c">C·{{ f.carbs }}g</mat-chip>
          <mat-chip class="chip chip-f">F·{{ f.fat }}g</mat-chip>
        </div>
      </div>

      <div class="col-actions">
        <button mat-icon-button class="row-action" type="button" (click)="onEdit(f)" aria-label="Edit">
          <mat-icon fontIcon="edit"></mat-icon>
        </button>

        <button mat-icon-button class="row-action" type="button" [matMenuTriggerFor]="rowMenu"
          aria-label="More actions">
          <mat-icon fontIcon="more_horiz"></mat-icon>
        </button>

        <mat-menu #rowMenu="matMenu">
          <button mat-menu-item type="button" (click)="onEdit(f)">
            <mat-icon fontIcon="edit"></mat-icon>
            Edit
          </button>

          @if (!f.isArchived) {
          <button mat-menu-item type="button" (click)="onArchive(f)">
            <mat-icon fontIcon="inventory_2"></mat-icon>
            Archive
          </button>
          }

          @if (f.isArchived) {
          <button mat-menu-item type="button" (click)="onRestore(f)">
            <mat-icon fontIcon="restore"></mat-icon>
            Restore
          </button>
          }

          <mat-divider></mat-divider>

          <button mat-menu-item class="danger" type="button" (click)="onDelete(f)">
            <mat-icon fontIcon="delete"></mat-icon>
            Delete
          </button>
        </mat-menu>
      </div>
    </div>
    }

    <!-- Empty state -->
    @if (visibleFoods().length === 0) {
    <div class="empty">
      <div class="empty-title">{{ searchQuery().trim() || archivedCount() === 0 ? "No foods found" : "All your foods are archived" }}</div>
      <div class="empty-sub">{{ searchQuery().trim() || archivedCount() === 0 ? "Try a different search, or create a custom food to get started." : "Show archived items to view or restore them, or create a new food to keep logging." }}</div>
      <button mat-raised-button class="btn-primary" type="button" (click)="onCreateFood()">
        <mat-icon fontIcon="add"></mat-icon>
        Create Food
      </button>
    </div>
    }

    <!-- Bulk bar -->
    @if (this.selectedIds().size > 0) {
    <div class="bulk">
      <div class="bulk-left">{{ this.selectedIds().size }} selected</div>
      <div class="bulk-actions">
        <button mat-stroked-button class="btn-danger" type="button" (click)="onBulkDelete()">Delete</button>
        <button mat-stroked-button type="button" (click)="clearSelection()">Cancel</button>
      </div>
    </div>
    }
    }
    @else {
    <!-- Skeleton rows -->
    @for (i of [1,2,3,4,5,6]; track i) {
    <div class="grid row sk-row" aria-hidden="true">
      <div class="col-select">
        <div class="sk sk-box"></div>
      </div>

      <div class="col-food">
        <div class="food-cell">
          <div class="sk sk-line w-55"></div>
          <div class="food-sub">
            <div class="sk sk-line w-18"></div>
            <span class="dot"></span>
            <div class="sk sk-line w-28"></div>
            <span class="dot"></span>
            <div class="sk sk-line w-22"></div>
          </div>
        </div>
      </div>

      <div class="col-kcal">
        <div class="kcal">
          <div class="sk sk-line w-45 sk-kcal"></div>
        </div>
      </div>

      <div class="col-macros">
        <div class="macro-chips">
          <div class="sk sk-chip"></div>
          <div class="sk sk-chip"></div>
          <div class="sk sk-chip"></div>
        </div>
      </div>

      <div class="col-actions">
        <div class="sk-actions">
          <div class="sk sk-icon"></div>
          <div class="sk sk-icon"></div>
        </div>
      </div>
    </div>
    }
    }

  </div>
</div>